#!/bin/bash

# arch-setup - Interactive CLI for Manjaro/Arch Linux setup
# Author: Bruno

# Note: set -e removed to allow graceful error handling in loops

# Get installation directory
INSTALL_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"

# Load core utilities
source "$INSTALL_DIR/core/config.sh"
source "$INSTALL_DIR/core/colors.sh"
source "$INSTALL_DIR/core/logger.sh"
source "$INSTALL_DIR/core/requirements.sh"
source "$INSTALL_DIR/core/user-config.sh"
source "$INSTALL_DIR/core/themes.sh"
source "$INSTALL_DIR/core/install-utils.sh"
source "$INSTALL_DIR/core/zsh-config.sh"
source "$INSTALL_DIR/core/terminal.sh"
source "$INSTALL_DIR/core/desktop.sh"

# Install All - Terminal Tools + Desktop Applications
install_all() {
    log_info "Starting full installation (Terminal + Desktop)..."
    
    gum style \
        --border double \
        --border-foreground 81 \
        --padding "1 2" \
        --bold \
        "Install All" \
        "" \
        "$(gum style --foreground 75 "This will install ALL terminal tools and desktop applications")" \
        "$(gum style --foreground 75 "No user interaction required - just sit back and relax!")"
    
    echo ""
    
    # Check installation requirements first
    if ! check_installation_requirements; then
        gum style --foreground 196 "âœ— Installation requirements check failed"
        log_error "Installation requirements check failed"
        gum confirm "Press Enter to continue..." && true
        return 1
    fi
    
    echo ""
    
    # Get all available tools and apps
    local terminal_tools=($(get_terminal_tools))
    local desktop_apps=($(get_desktop_apps))
    local total_items=$((${#terminal_tools[@]} + ${#desktop_apps[@]}))
    
    gum style --foreground 81 --bold "Found $total_items items to install:"
    gum style --foreground 75 "  â€¢ ${#terminal_tools[@]} terminal tools"
    gum style --foreground 75 "  â€¢ ${#desktop_apps[@]} desktop applications"
    echo ""
    
    # Counters
    local success_count=0
    local fail_count=0
    local current=0
    
    # Install all terminal tools
    gum style \
        --border rounded \
        --border-foreground 81 \
        --padding "1 2" \
        "Installing Terminal Tools (${#terminal_tools[@]} items)"
    echo ""
    
    for tool in "${terminal_tools[@]}"; do
        ((current++))
        local script="$INSTALL_DIR/terminal/${tool}.sh"
        
        if [ -f "$script" ]; then
            log_info "[$current/$total_items] Installing $tool..."
            gum style --foreground 81 "[$current/$total_items] â†’ Installing $tool..."
            
            # Convert tool name to function name (replace - with _)
            local func_name=$(echo "$tool" | tr '-' '_')
            
            # Source the script and call install function
            if source "$script" && install_${func_name}; then
                gum style --foreground 48 "  âœ“ $tool installed successfully"
                log_success "$tool installed successfully"
                ((success_count++))
            else
                gum style --foreground 196 "  âœ— Failed to install $tool"
                log_error "Failed to install $tool"
                ((fail_count++))
            fi
            echo ""
        else
            gum style --foreground 196 "  âœ— Script not found: $script"
            log_error "Script not found: $script"
            ((fail_count++))
        fi
    done
    
    # Install all desktop applications
    gum style \
        --border rounded \
        --border-foreground 81 \
        --padding "1 2" \
        "Installing Desktop Applications (${#desktop_apps[@]} items)"
    echo ""
    
    for app in "${desktop_apps[@]}"; do
        ((current++))
        local script="$INSTALL_DIR/desktop/${app}.sh"
        
        if [ -f "$script" ]; then
            log_info "[$current/$total_items] Installing $app..."
            gum style --foreground 81 "[$current/$total_items] â†’ Installing $app..."
            
            # Convert app name to function name (replace - with _)
            local func_name=$(echo "$app" | tr '-' '_')
            
            # Source the script and call install function
            if source "$script" && install_${func_name}; then
                gum style --foreground 48 "  âœ“ $app installed successfully"
                log_success "$app installed successfully"
                ((success_count++))
            else
                gum style --foreground 196 "  âœ— Failed to install $app"
                log_error "Failed to install $app"
                ((fail_count++))
            fi
            echo ""
        else
            gum style --foreground 196 "  âœ— Script not found: $script"
            log_error "Script not found: $script"
            ((fail_count++))
        fi
    done
    
    # Final Summary
    echo ""
    gum style \
        --border double \
        --border-foreground 81 \
        --padding "1 2" \
        --bold \
        "Installation Complete!" \
        "" \
        "$(gum style --foreground 48 "âœ“ Successfully installed: $success_count")" \
        "$(gum style --foreground 196 "âœ— Failed: $fail_count")" \
        "" \
        "$(gum style --foreground 75 "Total items: $total_items")"
    
    log_info "Install All completed: $success_count success, $fail_count failed"
    
    echo ""
    gum confirm "Press Enter to continue..." && true
    
    return 0
}

# Main menu
main_menu() {
    while true; do
        clear
        
        # Header
        gum style \
            --border double \
            --border-foreground 81 \
            --align center \
            --width 50 \
            --padding "1 2" \
            --margin "1 0" \
            "$(gum style --foreground 81 --bold "$APP_NAME") $(gum style --foreground 245 "v$APP_VERSION")" \
            "$(gum style --foreground 75 "$APP_DESCRIPTION")"
        
        echo ""
        
        # Menu options
        choice=$(gum choose \
            --cursor.foreground 81 \
            --header "What would you like to do?" \
            --header.foreground 81 \
            "1. Install All (Terminal + Desktop)" \
            "2. Configure System (Git, User Info)" \
            "3. Install Terminal Tools" \
            "4. Install Desktop Applications" \
            "5. Install Programming Languages (mise)" \
            "6. Apply Dotfiles Configuration" \
            "7. View Installation Status" \
            "8. Update Installed Packages" \
            "9. Exit")
        
        # Extract number from choice
        option=$(echo "$choice" | cut -d. -f1)
        
        case "$option" in
            1)
                install_all
                ;;
            2)
                configure_user
                ;;
            3)
                install_terminal_tools
                ;;
            4)
                install_desktop_apps
                ;;
            5)
                gum style --foreground 214 "TODO: Install Programming Languages"
                gum confirm "Press Enter to continue..." && true
                ;;
            6)
                gum style --foreground 214 "TODO: Apply Dotfiles"
                gum confirm "Press Enter to continue..." && true
                ;;
            7)
                gum style --foreground 214 "TODO: View Status"
                gum confirm "Press Enter to continue..." && true
                ;;
            8)
                gum style --foreground 214 "TODO: Update Packages"
                gum confirm "Press Enter to continue..." && true
                ;;
            9)
                clear
                gum style --foreground 46 "Goodbye! ðŸ‘‹"
                exit 0
                ;;
        esac
    done
}

# Start
init_logger
check_requirements
main_menu
