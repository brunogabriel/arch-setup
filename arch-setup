#!/bin/bash

# arch-setup - Interactive CLI for Manjaro/Arch Linux setup
# Author: Bruno

# Note: set -e removed to allow graceful error handling in loops

# Get installation directory
INSTALL_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"

# Load core utilities
source "$INSTALL_DIR/core/config.sh"
source "$INSTALL_DIR/core/colors.sh"
source "$INSTALL_DIR/core/logger.sh"
source "$INSTALL_DIR/core/requirements.sh"
source "$INSTALL_DIR/core/user-config.sh"
source "$INSTALL_DIR/core/themes.sh"
source "$INSTALL_DIR/core/install-utils.sh"
source "$INSTALL_DIR/core/zsh-config.sh"
source "$INSTALL_DIR/core/terminal.sh"
source "$INSTALL_DIR/core/desktop.sh"
source "$INSTALL_DIR/core/mise-install.sh"

# Install All - Terminal Tools + Desktop Applications
install_all() {
    log_info "Starting full installation (Terminal + Desktop)..."
    
    gum style \
        --border double \
        --border-foreground 81 \
        --padding "1 2" \
        --bold \
        "Install All" \
        "" \
        "$(gum style --foreground 75 "This will install ALL terminal tools and desktop applications")" \
        "$(gum style --foreground 75 "No user interaction required - just sit back and relax!")"
    
    echo ""
    
    # Check installation requirements first
    if ! check_installation_requirements; then
        gum style --foreground 196 "âœ— Installation requirements check failed"
        log_error "Installation requirements check failed"
        gum confirm "Press Enter to continue..." && true
        return 1
    fi
    
    echo ""
    
    # Get all available tools and apps
    local terminal_tools=($(get_terminal_tools))
    local desktop_apps=($(get_desktop_apps))
    local total_items=$((${#terminal_tools[@]} + ${#desktop_apps[@]}))
    
    gum style --foreground 81 --bold "Found $total_items items to install:"
    gum style --foreground 75 "  â€¢ ${#terminal_tools[@]} terminal tools"
    gum style --foreground 75 "  â€¢ ${#desktop_apps[@]} desktop applications"
    echo ""
    
    # Counters
    local success_count=0
    local fail_count=0
    local current=0
    
    # Install all terminal tools
    gum style \
        --border rounded \
        --border-foreground 81 \
        --padding "1 2" \
        "Installing Terminal Tools (${#terminal_tools[@]} items)"
    echo ""
    
    for tool in "${terminal_tools[@]}"; do
        ((current++))
        local script="$INSTALL_DIR/terminal/${tool}.sh"
        
        if [ -f "$script" ]; then
            log_info "[$current/$total_items] Installing $tool..."
            gum style --foreground 81 "[$current/$total_items] â†’ Installing $tool..."
            
            # Convert tool name to function name (replace - with _)
            local func_name=$(echo "$tool" | tr '-' '_')
            
            # Source the script and call install function
            if source "$script" && install_${func_name}; then
                gum style --foreground 48 "  âœ“ $tool installed successfully"
                log_success "$tool installed successfully"
                ((success_count++))
            else
                gum style --foreground 196 "  âœ— Failed to install $tool"
                log_error "Failed to install $tool"
                ((fail_count++))
            fi
            echo ""
        else
            gum style --foreground 196 "  âœ— Script not found: $script"
            log_error "Script not found: $script"
            ((fail_count++))
        fi
    done
    
    # Install all desktop applications
    gum style \
        --border rounded \
        --border-foreground 81 \
        --padding "1 2" \
        "Installing Desktop Applications (${#desktop_apps[@]} items)"
    echo ""
    
    for app in "${desktop_apps[@]}"; do
        ((current++))
        local script="$INSTALL_DIR/desktop/${app}.sh"
        
        if [ -f "$script" ]; then
            log_info "[$current/$total_items] Installing $app..."
            gum style --foreground 81 "[$current/$total_items] â†’ Installing $app..."
            
            # Convert app name to function name (replace - with _)
            local func_name=$(echo "$app" | tr '-' '_')
            
            # Source the script and call install function
            if source "$script" && install_${func_name}; then
                gum style --foreground 48 "  âœ“ $app installed successfully"
                log_success "$app installed successfully"
                ((success_count++))
            else
                gum style --foreground 196 "  âœ— Failed to install $app"
                log_error "Failed to install $app"
                ((fail_count++))
            fi
            echo ""
        else
            gum style --foreground 196 "  âœ— Script not found: $script"
            log_error "Script not found: $script"
            ((fail_count++))
        fi
    done
    
    # Final Summary
    echo ""
    gum style \
        --border double \
        --border-foreground 81 \
        --padding "1 2" \
        --bold \
        "Installation Complete!" \
        "" \
        "$(gum style --foreground 48 "âœ“ Successfully installed: $success_count")" \
        "$(gum style --foreground 196 "âœ— Failed: $fail_count")" \
        "" \
        "$(gum style --foreground 75 "Total items: $total_items")"
    
    log_info "Install All completed: $success_count success, $fail_count failed"
    
    echo ""
    gum confirm "Press Enter to continue..." && true
    
    return 0
}

# View Installation Status
# Shows which terminal tools and desktop apps are installed
view_installation_status() {
    log_info "Checking installation status..."
    
    clear
    gum style \
        --border double \
        --border-foreground 81 \
        --padding "1 2" \
        --bold \
        "Installation Status" \
        "" \
        "$(gum style --foreground 75 "Checking installed tools and applications...")"
    
    echo ""
    
    # Get all tools and apps
    local terminal_tools=($(get_terminal_tools))
    local desktop_apps=($(get_desktop_apps))
    
    local installed_count=0
    local not_installed_count=0
    
    # Check Terminal Tools
    gum style \
        --border rounded \
        --border-foreground 81 \
        --padding "1 2" \
        "Terminal Tools (${#terminal_tools[@]} total)"
    echo ""
    
    for tool in "${terminal_tools[@]}"; do
        local check_cmd=""
        local display_name="$tool"
        local is_installed=false
        
        # Special cases for command names and checks
        case "$tool" in
            "github-cli") check_cmd="gh" ;;
            "opencode") check_cmd="opencode" ;;
            "ripgrep") check_cmd="rg" ;;
            "fonts") 
                # Check if any nerd font is installed
                if fc-list | grep -qi "nerd"; then
                    gum style --foreground 48 "  âœ“ $display_name (nerd fonts installed)"
                    ((installed_count++))
                    is_installed=true
                else
                    gum style --foreground 245 "  â—‹ $display_name (not installed)"
                    ((not_installed_count++))
                    is_installed=true
                fi
                ;;
            *) check_cmd="$tool" ;;
        esac
        
        # Skip if already processed
        [ "$is_installed" = true ] && continue
        
        if command -v "$check_cmd" &> /dev/null; then
            local version=$(command $check_cmd --version 2>/dev/null | head -n1 | cut -d' ' -f1-3 || echo "installed")
            gum style --foreground 48 "  âœ“ $display_name ($version)"
            ((installed_count++))
        else
            gum style --foreground 245 "  â—‹ $display_name (not installed)"
            ((not_installed_count++))
        fi
    done
    
    echo ""
    
    # Check Desktop Applications
    gum style \
        --border rounded \
        --border-foreground 81 \
        --padding "1 2" \
        "Desktop Applications (${#desktop_apps[@]} total)"
    echo ""
    
    for app in "${desktop_apps[@]}"; do
        local check_cmd=""
        local display_name="$app"
        local is_installed=false
        
        # Special cases for command/package names
        case "$app" in
            "chrome") check_cmd="google-chrome-stable" ;;
            "vscode") check_cmd="code" ;;
            "brave") check_cmd="brave" ;;
            "cursor") check_cmd="cursor" ;;
            "warp-terminal") check_cmd="warp-terminal" ;;
            "jetbrains-toolbox") check_cmd="jetbrains-toolbox" ;;
            "bitwarden") check_cmd="bitwarden-desktop" ;;
            "heroic-games-launcher") check_cmd="heroic" ;;
            "xournal-app") check_cmd="xournalpp" ;;
            "lsfg-vk") check_cmd="lsfg-vk-ui" ;;
            "pinta") 
                # Check via flatpak (com.github.PintaProject.Pinta)
                if flatpak list --app 2>/dev/null | grep -qi "PintaProject.Pinta"; then
                    gum style --foreground 48 "  âœ“ $display_name (flatpak)"
                    ((installed_count++))
                else
                    gum style --foreground 245 "  â—‹ $display_name (not installed)"
                    ((not_installed_count++))
                fi
                is_installed=true
                ;;
            "podman-desktop") 
                # Check via flatpak (io.podman_desktop.PodmanDesktop)
                if flatpak list --app 2>/dev/null | grep -qi "podman_desktop.PodmanDesktop"; then
                    gum style --foreground 48 "  âœ“ $display_name (flatpak)"
                    ((installed_count++))
                elif command -v podman-desktop &> /dev/null; then
                    gum style --foreground 48 "  âœ“ $display_name (installed)"
                    ((installed_count++))
                else
                    gum style --foreground 245 "  â—‹ $display_name (not installed)"
                    ((not_installed_count++))
                fi
                is_installed=true
                ;;
            "tk") 
                # Check via flatpak or command
                if flatpak list --app 2>/dev/null | grep -qi "tk"; then
                    gum style --foreground 48 "  âœ“ $display_name (flatpak)"
                    ((installed_count++))
                elif command -v tk &> /dev/null; then
                    gum style --foreground 48 "  âœ“ $display_name (installed)"
                    ((installed_count++))
                else
                    gum style --foreground 245 "  â—‹ $display_name (not installed)"
                    ((not_installed_count++))
                fi
                is_installed=true
                ;;
            *) check_cmd="$app" ;;
        esac
        
        # Skip if already processed
        [ "$is_installed" = true ] && continue
        
        if command -v "$check_cmd" &> /dev/null; then
            gum style --foreground 48 "  âœ“ $display_name (installed)"
            ((installed_count++))
        else
            gum style --foreground 245 "  â—‹ $display_name (not installed)"
            ((not_installed_count++))
        fi
    done
    
    echo ""
    
    # Summary
    local total=$((installed_count + not_installed_count))
    local percentage=0
    if [ $total -gt 0 ]; then
        percentage=$((installed_count * 100 / total))
    fi
    
    gum style \
        --border double \
        --border-foreground 81 \
        --padding "1 2" \
        "Summary" \
        "" \
        "$(gum style --foreground 48 "âœ“ Installed: $installed_count")" \
        "$(gum style --foreground 245 "â—‹ Not Installed: $not_installed_count")" \
        "" \
        "$(gum style --foreground 81 "Progress: $percentage%")"
    
    log_info "Installation status checked: $installed_count installed, $not_installed_count not installed"
    
    echo ""
    gum confirm "Press Enter to continue..." && true
    return 0
}

# Main menu
main_menu() {
    while true; do
        clear
        
        # Header
        gum style \
            --border double \
            --border-foreground 81 \
            --align center \
            --width 50 \
            --padding "1 2" \
            --margin "1 0" \
            "$(gum style --foreground 81 --bold "$APP_NAME") $(gum style --foreground 245 "v$APP_VERSION")" \
            "$(gum style --foreground 75 "$APP_DESCRIPTION")"
        
        echo ""
        
        # Menu options
        choice=$(gum choose \
            --cursor.foreground 81 \
            --header "What would you like to do?" \
            --header.foreground 81 \
            "1. Install All (Terminal + Desktop)" \
            "2. Configure System (Git, User Info)" \
            "3. Install Terminal Tools" \
            "4. Install Desktop Applications" \
            "5. Install Programming Languages (mise)" \
            "6. View Installation Status" \
            "7. Exit")
        
        # Extract number from choice
        option=$(echo "$choice" | cut -d. -f1)
        
        case "$option" in
            1)
                install_all
                ;;
            2)
                configure_user
                ;;
            3)
                install_terminal_tools
                ;;
            4)
                install_desktop_apps
                ;;
            5)
                install_programming_language
                ;;
            6)
                view_installation_status
                ;;
            7)
                clear
                gum style --foreground 46 "Goodbye! ðŸ‘‹"
                exit 0
                ;;
        esac
    done
}

# Start
init_logger
check_requirements
main_menu
